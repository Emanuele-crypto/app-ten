import React, { useState, useEffect } from 'react';
import { Calculator, Beaker, AlertCircle, CheckCircle } from 'lucide-react';

const SuccoDepolpaturaCalculator = () => {
  const [volumeTotale, setVolumeTotale] = useState('');
  const [concentrazioneIniziale, setConcentrazioneIniziale] = useState('');
  const [concentrazioneDepolpata, setConcentrazioneDepolpata] = useState('0');
  const [concentrazioneTarget, setConcentrazioneTarget] = useState('2');
  const [risultati, setRisultati] = useState(null);
  const [errore, setErrore] = useState('');

  const calcolaProporzioni = () => {
    const volume = parseFloat(volumeTotale);
    const concIniziale = parseFloat(concentrazioneIniziale);
    const concDepolpata = parseFloat(concentrazioneDepolpata);
    const concTarget = parseFloat(concentrazioneTarget);

    // Validazione input
    if (!volume || volume <= 0) {
      setErrore('Inserire un volume valido maggiore di 0');
      setRisultati(null);
      return;
    }

    if (isNaN(concIniziale) || concIniziale <= 0) {
      setErrore('Inserire una concentrazione iniziale valida maggiore di 0%');
      setRisultati(null);
      return;
    }

    if (isNaN(concDepolpata) || concDepolpata < 0) {
      setErrore('Inserire una concentrazione depolpata valida maggiore o uguale a 0%');
      setRisultati(null);
      return;
    }

    if (isNaN(concTarget) || concTarget <= 0) {
      setErrore('Inserire una concentrazione target valida maggiore di 0%');
      setRisultati(null);
      return;
    }

    if (concIniziale > 100 || concDepolpata > 100 || concTarget > 100) {
      setErrore('Le concentrazioni non possono essere maggiori del 100%');
      setRisultati(null);
      return;
    }

    if (concDepolpata >= concIniziale) {
      setErrore('La concentrazione depolpata deve essere minore di quella iniziale');
      setRisultati(null);
      return;
    }

    if (concTarget <= concDepolpata || concTarget >= concIniziale) {
      setErrore('La concentrazione target deve essere compresa tra quella depolpata e quella iniziale');
      setRisultati(null);
      return;
    }

    // Calcoli con formula generalizzata: x × P1 + (1-x) × P2 = Target
    // x = (Target - P2) / (P1 - P2)
    const fractioneNonDepolpare = (concTarget - concDepolpata) / (concIniziale - concDepolpata);
    const fractioneDepolpare = 1 - fractioneNonDepolpare;
    
    const volumeNonDepolpare = fractioneNonDepolpare * volume;
    const volumeDepolpare = fractioneDepolpare * volume;
    const percentualeNonDepolpare = fractioneNonDepolpare * 100;
    const percentualeDepolpare = fractioneDepolpare * 100;

    setRisultati({
      volumeNonDepolpare: volumeNonDepolpare.toFixed(2),
      volumeDepolpare: volumeDepolpare.toFixed(2),
      percentualeNonDepolpare: percentualeNonDepolpare.toFixed(1),
      percentualeDepolpare: percentualeDepolpare.toFixed(1),
      concentrazioneIniziale: concIniziale,
      concentrazioneDepolpata: concDepolpata,
      concentrazioneTarget: concTarget,
      volumeTotale: volume
    });
    setErrore('');
  };

  // Calcolo automatico quando cambiano gli input
  useEffect(() => {
    if (volumeTotale && concentrazioneIniziale && concentrazioneDepolpata !== '' && concentrazioneTarget !== '') {
      calcolaProporzioni();
    } else {
      setRisultati(null);
      setErrore('');
    }
  }, [volumeTotale, concentrazioneIniziale, concentrazioneDepolpata, concentrazioneTarget]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 p-4">
      <div className="max-w-4xl mx-auto">
        <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
          {/* Header */}
          <div className="bg-gradient-to-r from-orange-500 to-amber-500 p-6 text-white">
            <div className="flex items-center gap-3">
              <Beaker size={32} />
              <div>
                <h1 className="text-2xl font-bold">Calcolatore Depolpatura Succo</h1>
                <p className="text-orange-100 mt-1">Calcola le proporzioni per ottenere qualsiasi concentrazione target</p>
              </div>
            </div>
          </div>

          <div className="p-6">
            {/* Form Input */}
            <div className="max-w-2xl mx-auto mb-8">
              <div className="space-y-4">
                <h2 className="text-xl font-semibold text-gray-800 flex items-center gap-2">
                  <Calculator size={20} />
                  Dati Iniziali
                </h2>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Volume Totale di Succo (litri)
                  </label>
                  <input
                    type="number"
                    value={volumeTotale}
                    onChange={(e) => setVolumeTotale(e.target.value)}
                    placeholder="es. 100"
                    min="0"
                    step="0.1"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Concentrazione Iniziale di Polpa (%)
                  </label>
                  <input
                    type="number"
                    value={concentrazioneIniziale}
                    onChange={(e) => setConcentrazioneIniziale(e.target.value)}
                    placeholder="es. 10"
                    min="0"
                    max="100"
                    step="0.1"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Concentrazione Succo Depolpato (%)
                  </label>
                  <input
                    type="number"
                    value={concentrazioneDepolpata}
                    onChange={(e) => setConcentrazioneDepolpata(e.target.value)}
                    placeholder="es. 0"
                    min="0"
                    max="100"
                    step="0.1"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Concentrazione Target Finale (%)
                  </label>
                  <input
                    type="number"
                    value={concentrazioneTarget}
                    onChange={(e) => setConcentrazioneTarget(e.target.value)}
                    placeholder="es. 2"
                    min="0"
                    max="100"
                    step="0.1"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
                  />
                </div>
              </div>
            </div>

            {/* Errori */}
            {errore && (
              <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
                <AlertCircle className="text-red-500 flex-shrink-0 mt-0.5" size={20} />
                <div>
                  <h4 className="text-red-800 font-medium">Errore</h4>
                  <p className="text-red-700 text-sm mt-1">{errore}</p>
                </div>
              </div>
            )}

            {/* Risultati */}
            {risultati && (
              <div className="bg-green-50 border border-green-200 rounded-lg p-6">
                <div className="flex items-center gap-2 mb-4">
                  <CheckCircle className="text-green-600" size={24} />
                  <h3 className="text-xl font-semibold text-green-800">Risultati</h3>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                  {/* Aliquote */}
                  <div className="space-y-4">
                    <div className="bg-white rounded-lg p-4 border-l-4 border-blue-500">
                      <h4 className="font-semibold text-blue-800 mb-2">Aliquota da NON depolpare</h4>
                      <div className="text-2xl font-bold text-blue-900">{risultati.volumeNonDepolpare} litri</div>
                      <div className="text-sm text-blue-700">({risultati.percentualeNonDepolpare}% del totale)</div>
                      <div className="text-xs text-blue-600 mt-1">Mantiene polpa al {risultati.concentrazioneIniziale}%</div>
                    </div>

                    <div className="bg-white rounded-lg p-4 border-l-4 border-purple-500">
                      <h4 className="font-semibold text-purple-800 mb-2">Aliquota da depolpare</h4>
                      <div className="text-2xl font-bold text-purple-900">{risultati.volumeDepolpare} litri</div>
                      <div className="text-sm text-purple-700">({risultati.percentualeDepolpare}% del totale)</div>
                      <div className="text-xs text-purple-600 mt-1">Riduce polpa al {risultati.concentrazioneDepolpata}%</div>
                    </div>
                  </div>

                  {/* Visualizzazione grafica */}
                  <div className="space-y-4">
                    <h4 className="font-semibold text-gray-800">Proporzioni Visive</h4>
                    
                    {/* Barra di composizione */}
                    <div className="bg-gray-200 rounded-lg overflow-hidden h-8 flex">
                      <div 
                        className="bg-blue-500 flex items-center justify-center text-white text-xs font-medium"
                        style={{ width: `${risultati.percentualeNonDepolpare}%` }}
                      >
                        {risultati.percentualeNonDepolpare}%
                      </div>
                      <div 
                        className="bg-purple-500 flex items-center justify-center text-white text-xs font-medium"
                        style={{ width: `${risultati.percentualeDepolpare}%` }}
                      >
                        {risultati.percentualeDepolpare}%
                      </div>
                    </div>

                    <div className="text-sm text-gray-600 space-y-1">
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-blue-500 rounded"></div>
                        <span>Non depolpare</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-purple-500 rounded"></div>
                        <span>Depolpare</span>
                      </div>
                    </div>

                    {/* Risultato finale */}
                    <div className="bg-green-100 rounded-lg p-3 mt-4">
                      <div className="text-center">
                        <div className="text-lg font-bold text-green-800">Risultato Finale</div>
                        <div className="text-2xl font-bold text-green-900">{risultati.volumeTotale} litri</div>
                        <div className="text-sm text-green-700">Succo con polpa al {risultati.concentrazioneTarget}%</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Istruzioni */}
            <div className="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
              <h3 className="font-semibold text-blue-800 mb-3">Come utilizzare i risultati:</h3>
              <ol className="list-decimal list-inside text-blue-700 space-y-2 text-sm">
                <li>Prendi l'aliquota indicata e NON depolparla (mantiene la concentrazione originale)</li>
                <li>Prendi l'aliquota rimanente e depolpala completamente (concentrazione 0%)</li>
                <li>Miscela le due aliquote per ottenere il succo finale al 2% di polpa</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default SuccoDepolpaturaCalculator;
